<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Townhall Results — Rohit Group</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--accent:#0f6b61;--muted:#6b7176;--bg:#f6faf9;font-family:Inter,-apple-system,system-ui,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:#0f1720}
    .wrap{max-width:920px;margin:28px auto;padding:18px}
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(11,87,79,0.06)}
    h1{margin:0 0 8px;font-size:18px}
    .row{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eef6f4}
    .label{font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .comment{padding:10px;border-radius:8px;border:1px solid #eef6f4;margin-bottom:8px;background:#fbfffd}
    .controls{display:flex;gap:10px;margin-top:12px}
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:9px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Townhall Feedback — Results</h1>
      <div id="meta" class="muted">Loading…</div>
      <div id="averages" style="margin-top:12px"></div>

      <div class="controls">
        <button id="downloadCsv">Download CSV</button>
        <button id="back">Back to survey</button>
        <div style="margin-left:auto" class="muted">This reads submissions stored in this browser (localStorage).</div>
      </div>

      <section style="margin-top:14px">
        <h3 style="margin:0 0 8px">Comments</h3>
        <div id="commentsArea" class="muted">Loading comments…</div>
      </section>
    </div>
  </div>

<script>
(function(){
  const key = 'townhall_feedback_submissions';
  const raw = localStorage.getItem(key);
  const meta = document.getElementById('meta');
  const avgContainer = document.getElementById('averages');
  const commentsArea = document.getElementById('commentsArea');

  if(!raw){ meta.textContent='No submissions found.'; avgContainer.innerHTML=''; commentsArea.innerHTML=''; return; }
  const arr = JSON.parse(raw || '[]');
  meta.textContent = 'Total submissions: ' + (arr.length || 0);

  const fields = [
    {k:'rotreat', label:'Rotreat Recap'},
    {k:'budget', label:'2026 Budget Highlights'},
    {k:'case_study', label:'Case Study Discussion'},
    {k:'accounting', label:'Accounting Highlights & 2026 Plans'},
    {k:'tax', label:'Tax Highlights & 2026 Plans'},
    {k:'new_hires', label:'New Hire Introductions'},
    {k:'overall', label:'Overall Townhall Rating'}
  ];

  function avg(values){ if(!values.length) return null; return (values.reduce((a,b)=>a+b,0)/values.length); }

  avgContainer.innerHTML = fields.map(f=>{
    const vals = arr.map(x=>Number(x[f.k]||0)).filter(v=>v>0);
    const a = avg(vals);
    return `<div class="row"><div class="label">${f.label}</div><div>${a ? a.toFixed(2)+' / 5' : '—'}</div></div>`;
  }).join('');

  const comments = arr.filter(r=> r.comments && r.comments.trim());
  if(!comments.length) commentsArea.textContent='No comments yet.';
  else commentsArea.innerHTML = comments.map(c=>{
    const who = c.anonymous ? 'Anonymous' : (c.name || c.email || 'Participant');
    return `<div class="comment"><div style="font-weight:600;margin-bottom:6px">${who}</div><div>${escapeHtml(c.comments)}</div></div>`;
  }).join('');

  document.getElementById('back').addEventListener('click', ()=> location.href='survey.html');
  document.getElementById('downloadCsv').addEventListener('click', ()=>{
    if(!arr.length){ alert('No submissions'); return; }
    const headers = Object.keys(arr[0]);
    const csv = [headers.join(',')].concat(arr.map(r => headers.map(h => '"'+String(r[h]||"").replace(/"/g,'""') + '"').join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='townhall_feedback_all.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
})();
</script>
</body>
</html>
